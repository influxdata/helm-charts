{{- if .Values.service.enabled -}}
{{- $protocols := fromYaml (include "service.protocols" .) -}}
{{- $outer := . -}}
{{- range $i, $key := keys $protocols | sortAlpha -}}
{{- $ps := get $protocols $key -}}
{{- $nameExt := ternary "" (printf "-%s" $key) (empty $key) -}}
{{- with $outer }}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "telegraf.fullname" . }}{{ $nameExt }}
  labels:
    {{- include "telegraf.labels" . | nindent 4 }}
  {{- if .Values.service.annotations }}
  annotations:
{{ toYaml .Values.service.annotations | indent 4 }}
  {{- end }}
spec:
  type: {{ .Values.service.type }}
  {{- if and (eq .Values.service.type "LoadBalancer") .Values.service.loadBalancerIP }}
  loadBalancerIP: {{ .Values.service.loadBalancerIP }}
  {{- end }}
  ports:
  {{- if .Values.metrics.health.enabled }}
    {{- $entry := fromYaml (include "service.health" .) -}}
    {{- if not (empty $entry) -}}
      {{- $protocol := default "TCP" $entry.protocol -}}
      {{- if has $protocol $ps -}}
        {{ toYaml (list $entry) | nindent 2 }}
      {{- end -}}
    {{- end -}}
  {{- end }}
  {{- range $objectKey, $objectValue := .Values.config.inputs }}
  {{- range $key, $value := . }}
    {{- $entry := fromYaml (include "service.inputs" (list $key $value)) -}}
    {{- if not (empty $entry) -}}
      {{- $protocol := default "TCP" $entry.protocol -}}
      {{- if has $protocol $ps -}}
        {{ toYaml (list $entry) | nindent 2 }}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- end }}
  {{- range $objectKey, $objectValue := .Values.config.outputs }}
  {{- range $key, $value := . -}}
    {{- $entry := fromYaml (include "service.outputs" (list $key $value)) -}}
    {{- if not (empty $entry) -}}
      {{- $protocol := default "TCP" $entry.protocol -}}
      {{- if has $protocol $ps -}}
        {{ toYaml (list $entry) | nindent 2 }}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- end }}
  selector:
    {{- include "telegraf.selectorLabels" . | nindent 4 }}
{{- end }}
{{- if and (gt (len $protocols) 1) (lt $i (len $protocols)) }}
---
{{- end }}
{{- end -}}
{{- end -}}
